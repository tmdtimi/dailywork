# ACID:

![图片](https://uploader.shimo.im/f/MvuqRRLEsa5m3lDl.png!thumbnail)

# 事务隔离级别实际解决的问题：

![图片](https://uploader.shimo.im/f/Z5L4f0dHh4zw58Pp.png!thumbnail)

![图片](https://uploader.shimo.im/f/LYOE7mXG6orBj3M2.png!thumbnail)

![图片](https://uploader.shimo.im/f/zH2IUNGIkpYRACFv.png!thumbnail)



# 事务的隔离级别：

![图片](https://uploader.shimo.im/f/zeNhMlQGAbP2EN1D.png!thumbnail)



![图片](https://uploader.shimo.im/f/r6nGOfKFLiX0b1UH.png!thumbnail)

![图片](https://uploader.shimo.im/f/a1PAKTUsUFpGYZUp.png!thumbnail)

![图片](https://uploader.shimo.im/f/PX5gGyrsgSgAkXQ3.png!thumbnail)

![图片](https://uploader.shimo.im/f/Cylrh56fOuInuOkB.png!thumbnail)

## 事务操作数据丢失问题

可重复读

![图片](https://uploader.shimo.im/f/Dm6yxs4YQ5e2uF3D.png!thumbnail)

![图片](https://uploader.shimo.im/f/is66bpVNUffwJIKC.png!thumbnail)



## LBCC（基于锁的并发控制）解决数据丢失

使用锁的机制，在当前事务需要对数据修改时，将当前事务加上锁，同一个时间只允许一条事务修改当前数据，其他事务必须等待锁释放之后才可以操作。

## MVCC（**多版本的并发控制**） 解决数据丢失

使用版本来控制并发情况下的数据问题，**在B事务开始修改账户且事务未提交时，当A事务需要读取账户余额时，此时会读取到B事务修改操作之前的账户余额的副本数据**，**但是如果A事务需要修改账户余额数据就必须要等待B事务提交事务。**

**MVCC使得数据库读不会对数据加锁，普通的SELECT请求不会加锁，提高了数据库的并发处理能力。**借助MVCC，数据库可以实现READ COMMITTED，REPEATABLE READ等隔离级别，用户可以查看当前数据的前一个或者前几个历史版本，保证了ACID中的I特性（隔离性)。

# 为什么需要MVCC：
数据库通常使用锁来实现隔离性。最原生的锁，锁住一个资源后会禁止其他任何线程访问同一个资源。但是很多应用的一个特点都是读多写少的场景，很多数据的读取次数远大于修改的次数，而读取数据间互相排斥显得不是很必要。所以就使用了一种读写锁的方法，读锁和读锁之间不互斥，而写锁和写锁、读锁都互斥。这样就很大提升了系统的并发能力。

之后人们发现并发读还是不够，又**提出了能不能让读写之间也不冲突的方法，就是读取数据时通过一种类似快照的方式将数据保存下来**，**这样读锁就和写锁不冲突了，不同的事务session会看到自己特定版本的数据。**当然快照是一种概念模型，不同的数据库可能用不同的方式来实现这种功能。

MVCC只在 READ COMMITTED 和 REPEATABLE READ 两个隔离级别下工作。其他两个隔离级别够和MVCC不兼容, 因为 READ UNCOMMITTED 总是读取最新的数据行, 而不是符合当前事务版本的数据行。而 SERIALIZABLE 则会对所有读取的行都加锁。


# MVCC实现可重复读  读提交：

![图片](https://uploader.shimo.im/f/7V3k83Wv6qah9w3o.png!thumbnail)

![图片](https://uploader.shimo.im/f/VSBprKKhWsfvOItO.png!thumbnail)

![图片](https://uploader.shimo.im/f/MFbeV1al3BqoxPqm.png!thumbnail)![图片](https://uploader.shimo.im/f/YVRT1AX6AQxQeYt8.png!thumbnail)

MVCC在mysql中每一行提供两个字段 事务id 和 回滚指针

实现依赖的是 undo log 与 read view

![图片](https://uploader.shimo.im/f/qiyI9cKz6X71MKEw.png!thumbnail)

![图片](https://uploader.shimo.im/f/TUetRUxNiRny9Gjh.png!thumbnail)![图片](https://uploader.shimo.im/f/72JprJIR4S2wozWk.png!thumbnail)

为了保证事务并发操作时，在写各自的undo log时不产生冲突，InnoDB采用回滚段的方式来维护undo log的并发写入和持久化。回滚段实际上是一种 Undo 文件组织方式。

![图片](https://uploader.shimo.im/f/Z0Saz1ffCDlLS1YU.png!thumbnail)![图片](https://uploader.shimo.im/f/jZEeyECQ3a0lPLQh.png!thumbnail)

![图片](https://uploader.shimo.im/f/Cozz7q0WAqLywwaH.png!thumbnail)


MVCC实现读已提交

![图片](https://uploader.shimo.im/f/jrwNYWtrZdXyrI1b.png!thumbnail)

![图片](https://uploader.shimo.im/f/VpO5V5TkMSE05ZN2.png!thumbnail)

![图片](https://uploader.shimo.im/f/LyEUI1b058nvhL94.png!thumbnail)


![图片](https://uploader.shimo.im/f/iWOdChPhd1jspkme.png!thumbnail)

![图片](https://uploader.shimo.im/f/XxsousKIyEsLKB98.png!thumbnail)

![图片](https://uploader.shimo.im/f/ftlNbMMtgnTQsiWV.png!thumbnail)

![图片](https://uploader.shimo.im/f/JWrbGsOXtjZZycnq.png!thumbnail)![图片](https://uploader.shimo.im/f/0lsZQXUVlIJOvRq9.png!thumbnail)

MVCC实现可重复读：

![图片](https://uploader.shimo.im/f/kHkpmK8PF9RHRb7Q.png!thumbnail)

![图片](https://uploader.shimo.im/f/MVd239NMoBK94kPF.png!thumbnail)

![图片](https://uploader.shimo.im/f/WGkPI40Gi4bmASq8.png!thumbnail)

![图片](https://uploader.shimo.im/f/tOtQWpUc1mZdq6AY.png!thumbnail)

![图片](https://uploader.shimo.im/f/RVhvmeYtHY3ugzrB.png!thumbnail)

![图片](https://uploader.shimo.im/f/j3rqaclKEUVARPxv.png!thumbnail)

![图片](https://uploader.shimo.im/f/K0kNDZK7cN5YgzH2.png!thumbnail)

# 

# 并发写问题：（加行锁）
![图片](https://uploader.shimo.im/f/SH8rGt1ihpCL5skL.png!thumbnail)

![图片](https://uploader.shimo.im/f/RQ4RpoNt5jMCJ89n.png!thumbnail)

![图片](https://uploader.shimo.im/f/ks0GlJbW0AzKohfh.png!thumbnail)


# 幻读问题：（间隙锁）
![图片](https://uploader.shimo.im/f/HcXbufKwHDXmiam6.png!thumbnail)

![图片](https://uploader.shimo.im/f/PqFhZXnIiq0gIS6R.png!thumbnail)

![图片](https://uploader.shimo.im/f/flpDQ1XMpV3mgtaO.png!thumbnail)

![图片](https://uploader.shimo.im/f/K7ESVKC95lY2YxAD.png!thumbnail)

![图片](https://uploader.shimo.im/f/W2hHSSxtwJtHVchp.png!thumbnail)

![图片](https://uploader.shimo.im/f/t1PQlePsFWTLTUIi.png!thumbnail)


























# 


















