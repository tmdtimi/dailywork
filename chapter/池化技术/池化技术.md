## 池化技术

内存、连接、线程这些都是资源，创建线程、分配内存、数据库连接这些操作都有一个特征，那就是创建和销毁过程都会涉及到很多系统调用或者网络 IO。 

每次都在请求中去申请创建这些资源，就会增加请求处理耗时，但是如果我们用一个容器（池）把它们保存起来，下次需要的时候，直接拿出来使用，避免重复创建和销毁浪费的时间。 嗯嗯


### 内存池

内存池就是在使用内存前，先向系统申请一块空间留做备用，使用者需要内池时向内存池申请，用完后还回来。

难点在于：
	
1. 如何快速分配内存
2. 降低内存碎片率
3. 维护内存池所需的额外空间尽量少

如果不考虑效率，我们完全可以将内存分为不同大小的块，然后用链表连接起来，分配的时候找到大小最合适的返回，释放的时候直接添加进链表。

![](../pics/a1.png)

Google 的 「tcmalloc」 和 Facebook 的 「jemalloc」

动态内存分配算法


### 线程池

线程是程序执行的实体。

在服务器开发中，会为每个请求分配一个线程去处理，但是创建线程，销毁都会导致额外的开销。线程多了也会导致系统整体性能下降。

在这种场景下，我们通常会提前创建若干个线程，通过线程池来进行管理。当请求来到时，只需从线程池中选一个线程执行任务。

线程池还可以与队列一起使用来实现任务调度。

主线程收到请求后将创建对应的任务，然后放在队列里，线程池中的工作线程等待队列的任务。

线程池一般由四个核心部分组成：

1. 管理器：用于创建并管理线程
2. 工作线程:执行任务的线程
3. 任务接口：每个具体的任务必须实现任务接口，工作线程将调用接口来完成具体任务。
4. 任务队列Queue： 存放还未执行的任务

![](../pics/a2.png)

**ThreadPoolExcutor**

![](../pics/a3.png)

![](../pics/a4.png)




### 连接池

连接池是创建和管理连接的。

一次 SQL 查询请求会经过哪些步骤:

和 MySQL server 建立 TCP 连接:

三次握手

MySQL 权限认证

Server 向 Client 发送 密钥

Client 使用密钥加密用户名、密码等信息，将加密后的报文发送给 Server

Server 根据 Client 请求包，验证是否是合法用户，然后给 Client 发送认证结果

Client 发送 SQL 语句

Server 返回语句执行结果

MySQL 关闭

TCP 连接断开

四次挥手

可以看出不使用连接池的话，为了执行一条 SQL，会花很多时间在安全认证、网络IO上。

如果使用连接池，执行一条 SQL 就省去了建立连接和断开连接所需的额外开销。

池化实际上是预处理和延后处理的一种应用场景，通过池子将各类资源的创建提前和销毁延后-
